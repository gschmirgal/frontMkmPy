{% extends 'base.html.twig' %}

{% block title %}{{ 'app.navigation.rankings'|trans }}{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-4">
                <i class="bi bi-graph-up-arrow"></i>
                {{ 'app.navigation.rankings'|trans }}
            </h1>

            {# Filters #}
            <div class="ranking-filters-modern mb-4">
                <div class="d-flex flex-column flex-md-row gap-3">
                    {# Timeframe filter #}
                    <div class="filter-group">
                        <div class="filter-label">{{ 'app.ranking.filter.timeframe'|trans }}</div>
                        <div class="filter-options">
                            <a href="{{ path('app_rankings', {timeframe: '1d', foil: foil}) }}"
                               class="filter-option {{ timeframe == '1d' ? 'active' : '' }}">
                                {{ 'app.ranking.timeframe.1d'|trans }}
                            </a>
                            <a href="{{ path('app_rankings', {timeframe: '7d', foil: foil}) }}"
                               class="filter-option {{ timeframe == '7d' ? 'active' : '' }}">
                                {{ 'app.ranking.timeframe.7d'|trans }}
                            </a>
                            <a href="{{ path('app_rankings', {timeframe: '30d', foil: foil}) }}"
                               class="filter-option {{ timeframe == '30d' ? 'active' : '' }}">
                                {{ 'app.ranking.timeframe.30d'|trans }}
                            </a>
                        </div>
                    </div>

                    {# Foil filter #}
                    <div class="filter-group">
                        <div class="filter-label">{{ 'app.ranking.filter.variant'|trans }}</div>
                        <div class="filter-options">
                            <a href="{{ path('app_rankings', {timeframe: timeframe, foil: 'normal'}) }}"
                               class="filter-option {{ foil == 'normal' ? 'active' : '' }}">
                                {{ 'app.ranking.variant.normal'|trans }}
                            </a>
                            <a href="{{ path('app_rankings', {timeframe: timeframe, foil: 'foil'}) }}"
                               class="filter-option {{ foil == 'foil' ? 'active' : '' }}">
                                <i class="bi bi-stars"></i> {{ 'app.ranking.variant.foil'|trans }}
                            </a>
                        </div>
                    </div>

                    {# Reserved List filter #}
                    <div class="filter-group ms-md-auto align-self-center">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="ignoreReservedList">
                            <label class="form-check-label" for="ignoreReservedList">
                                {{ 'app.filter.ignore_reserved_list'|trans }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Top Gainers Section #}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-arrow-up-circle text-success"></i>
                {{ 'app.ranking.title.gainers'|trans }}
            </h2>
        </div>

        {# Gainers - Absolute Variation #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white collapse-toggle" role="button" data-bs-toggle="collapse" data-bs-target="#gainersAbsolute" aria-expanded="true" aria-controls="gainersAbsolute" style="cursor: pointer;">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-currency-euro"></i>
                        {{ 'app.ranking.variation.absolute'|trans }}
                        <i class="bi bi-chevron-down float-end collapse-chevron"></i>
                    </h4>
                </div>
                <div class="card-body p-0 collapse show" id="gainersAbsolute">
                    {{ include('ranking/_ranking_table.html.twig', {
                        items: rankings.gainers.absolute,
                        type: 'gainers',
                        showAbsolute: true
                    }) }}
                </div>
            </div>
        </div>

        {# Gainers - Relative Variation #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white collapse-toggle" role="button" data-bs-toggle="collapse" data-bs-target="#gainersRelative" aria-expanded="true" aria-controls="gainersRelative" style="cursor: pointer;">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-percent"></i>
                        {{ 'app.ranking.variation.relative'|trans }}
                        <i class="bi bi-chevron-down float-end collapse-chevron"></i>
                    </h4>
                </div>
                <div class="card-body p-0 collapse show" id="gainersRelative">
                    {{ include('ranking/_ranking_table.html.twig', {
                        items: rankings.gainers.relative,
                        type: 'gainers',
                        showAbsolute: false
                    }) }}
                </div>
            </div>
        </div>
    </div>

    {# Top Losers Section #}
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="bi bi-arrow-down-circle text-danger"></i>
                {{ 'app.ranking.title.losers'|trans }}
            </h2>
        </div>

        {# Losers - Absolute Variation #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-danger">
                <div class="card-header bg-danger text-white collapse-toggle" role="button" data-bs-toggle="collapse" data-bs-target="#losersAbsolute" aria-expanded="true" aria-controls="losersAbsolute" style="cursor: pointer;">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-currency-euro"></i>
                        {{ 'app.ranking.variation.absolute'|trans }}
                        <i class="bi bi-chevron-down float-end collapse-chevron"></i>
                    </h4>
                </div>
                <div class="card-body p-0 collapse show" id="losersAbsolute">
                    {{ include('ranking/_ranking_table.html.twig', {
                        items: rankings.losers.absolute,
                        type: 'losers',
                        showAbsolute: true
                    }) }}
                </div>
            </div>
        </div>

        {# Losers - Relative Variation #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-danger">
                <div class="card-header bg-danger text-white collapse-toggle" role="button" data-bs-toggle="collapse" data-bs-target="#losersRelative" aria-expanded="true" aria-controls="losersRelative" style="cursor: pointer;">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-percent"></i>
                        {{ 'app.ranking.variation.relative'|trans }}
                        <i class="bi bi-chevron-down float-end collapse-chevron"></i>
                    </h4>
                </div>
                <div class="card-body p-0 collapse show" id="losersRelative">
                    {{ include('ranking/_ranking_table.html.twig', {
                        items: rankings.losers.relative,
                        type: 'losers',
                        showAbsolute: false
                    }) }}
                </div>
            </div>
        </div>
    </div>
</div>

{# Add hover image script #}
<script>
function initializeRankingPage() {
    const hoverImg = document.getElementById('hover-img');
    const cardImages = document.querySelectorAll('.card-hover-img');

    cardImages.forEach(img => {
        img.addEventListener('mouseenter', function(e) {
            const imgUrl = this.getAttribute('data-img');
            if (imgUrl) {
                hoverImg.src = imgUrl;
                hoverImg.style.display = 'block';
            }
        });

        img.addEventListener('mousemove', function(e) {
            hoverImg.style.left = (e.pageX + 20) + 'px';
            hoverImg.style.top = (e.pageY + 20) + 'px';
        });

        img.addEventListener('mouseleave', function() {
            hoverImg.style.display = 'none';
        });
    });

    // Reserved List filter
    function toggleReservedList(hide) {
        localStorage.setItem('ignoreReservedList', hide ? 'true' : 'false');

        const tables = document.querySelectorAll('.table tbody');
        tables.forEach(tbody => {
            const rows = tbody.querySelectorAll('tr');

            // First pass: hide/show reserved cards
            rows.forEach(row => {
                const reserved = row.getAttribute('data-reserved');
                if (reserved === 'true') {
                    row.style.display = hide ? 'none' : '';
                }
            });

            // Second pass: recalculate rank numbers for visible rows
            let visibleRank = 1;
            rows.forEach(row => {
                const reserved = row.getAttribute('data-reserved');

                // Skip if this is the "no data" row
                if (reserved === null) {
                    return;
                }

                // Check if row is visible
                const isHidden = (reserved === 'true' && hide);

                if (!isHidden) {
                    const rankCell = row.querySelector('.rank-number');
                    if (rankCell) {
                        rankCell.textContent = visibleRank;
                        visibleRank++;
                    }
                }
            });
        });
    }

    // Initialize Reserved List filter
    const ignoreRLCheckbox = document.getElementById('ignoreReservedList');
    if (ignoreRLCheckbox) {
        // Set initial state from localStorage
        const ignoreRL = localStorage.getItem('ignoreReservedList') === 'true';
        ignoreRLCheckbox.checked = ignoreRL;
        toggleReservedList(ignoreRL);

        // Add event listener
        ignoreRLCheckbox.addEventListener('change', function() {
            toggleReservedList(this.checked);
        });
    }

    // Save and restore collapse state for each table
    const collapseElements = document.querySelectorAll('.card-body.collapse');

    // Restore collapse state from localStorage
    collapseElements.forEach(element => {
        const id = element.id;
        const savedState = localStorage.getItem('collapse_' + id);

        if (savedState === 'hidden') {
            // Remove 'show' class to collapse the element
            element.classList.remove('show');
            // Add 'collapsed' class to header for chevron rotation
            const header = document.querySelector('[data-bs-target="#' + id + '"]');
            if (header) {
                header.classList.add('collapsed');
                header.setAttribute('aria-expanded', 'false');
            }
        }
    });

    // Save collapse state when user clicks on toggle
    const toggleHeaders = document.querySelectorAll('.collapse-toggle');
    toggleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target').substring(1); // Remove '#'
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                // Check if element is currently shown
                const isCurrentlyShown = targetElement.classList.contains('show');

                // Save the opposite state (because click will toggle it)
                if (isCurrentlyShown) {
                    localStorage.setItem('collapse_' + targetId, 'hidden');
                } else {
                    localStorage.setItem('collapse_' + targetId, 'shown');
                }
            }
        });
    });
}

// Initialize on DOMContentLoaded (for regular page loads)
document.addEventListener('DOMContentLoaded', initializeRankingPage);

// Initialize on turbo:load (for Turbo/AJAX navigation)
document.addEventListener('turbo:load', initializeRankingPage);

// Also try turbo:render for Symfony UX Turbo
document.addEventListener('turbo:render', initializeRankingPage);
</script>
{% endblock %}
