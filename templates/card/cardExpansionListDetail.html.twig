{% extends 'base.html.twig' %}

{% block title %}{{"Card Details - "~card.name~"-"~expansion.name}} {% endblock %}
{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles/expansionCardListDetail.css') }}">
{% endblock %}

{% block body %}
    <h1><a href="{{ path('card.expansionlist', {id: card.id })}}">{{ card.name }}</a> - <a href="{{ path('expansion.cardlist', {id: expansion.id })}}">{{ expansion.name }}</a></h1>
    <div class="row align-items-center">
            <div class="col-12 col-md-auto text-center d-print-none">
                <div class="position-relative d-inline-block my-4">
                    <img src="{{ cardArt }}" alt="{{ card.name }}" class="img-fluid bigmtgcard" onclick="flipCard()" id="cardImage" data-front="{{ cardArt }}" data-back="{{ cardArtBack|default('') }}" data-showing="front">
                    {% if cardArtBack %}
                        <button class="btn btn-sm btn-outline-primary position-absolute btn-light rounded-circle" onclick="flipCard()" id="flipBtn" >
                            <i class="bi bi-arrow-clockwise h4"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
        <div class="col">
            {{ render_chart(chart,{'class': 'price-chart'}) }}
        </div>
    </div>
    {{ component('button', {link: "https://www.cardmarket.com/en/Magic/Products?isFoil=Y&idProduct="~cardId, text: "Buy Foil on CardMarket"}) }}
    {{ component('button', {link: "https://www.cardmarket.com/en/Magic/Products?idProduct="~cardId, text: "Buy on CardMarket"}) }}
    {{ component('button', {btnType: "btn-info", link: scryfalluri, text: "Scryfall"}) }}
    {{ component('button', {btnType: "btn-danger", link: gathereruri, text: "Gatherer"}) }}

    {{ component('table', {headers: headerstable, rows: prices, addPaginationRender: addPaginationRender, exporterPath: exporterPath, exporterParams: exporterParams}) }}

    
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if cardArtBack %}
    <script>
        let isFlipping = false;
        let preloadImage = null;
        
        // Réinitialiser au chargement de la page
        document.addEventListener('turbo:load', function() {
            resetCardImage();
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            resetCardImage();
        });
        
        function resetCardImage() {
            const cardImage = document.getElementById('cardImage');
            if (cardImage) {
                // Remettre sur la face avant
                cardImage.src = cardImage.dataset.front;
                cardImage.dataset.showing = 'front';
                cardImage.classList.remove('flipping');
                isFlipping = false;
                
                // Précharger l'image arrière
                if (cardImage.dataset.back && !preloadImage) {
                    preloadImage = new Image();
                    preloadImage.src = cardImage.dataset.back;
                }
            }
        }
        
        function flipCard() {
            if (isFlipping) return;
            
            const cardImage = document.getElementById('cardImage');
            if (!cardImage || !cardImage.dataset.back) return;
            
            isFlipping = true;
            
            // Animation de sortie
            cardImage.classList.add('flipping');
            
            setTimeout(() => {
                // Changer l'image
                if (cardImage.dataset.showing === 'front') {
                    cardImage.src = cardImage.dataset.back;
                    cardImage.dataset.showing = 'back';
                } else {
                    cardImage.src = cardImage.dataset.front;
                    cardImage.dataset.showing = 'front';
                }
                
                // Animation d'entrée
                setTimeout(() => {
                    cardImage.classList.remove('flipping');
                    isFlipping = false;
                }, 50);
            }, 200);
        }
    </script>
    {% endif %}
{% endblock %}

